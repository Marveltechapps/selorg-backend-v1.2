name: Deploy Selorg Dashboard Backend (Rollback Safe)

on:
  push:
    branches:
      - main   # ‚úÖ changed to main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -e
    
            echo "============================="
            echo "üöÄ BACKEND DEPLOYMENT STARTED"
            echo "============================="
    
            BACKEND_DIR="/home/ubuntu/selorg/selorg-backend-v1.2"   # ‚úÖ updated path
            DOCKERFILE="/home/ubuntu/selorg/Dockerfiles/Dockerfile-backend"
            ENV_FILE="/home/ubuntu/selorg/envs/backend.env"
            IMAGE_NAME="selorg-backend"
            CONTAINER_NAME="selorg-backend"
            BRANCH="main"   # ‚úÖ changed branch
    
            echo "‚û°Ô∏è Go to backend directory"
            cd $BACKEND_DIR
    
            echo "üßπ Sync repository"
            git fetch origin
            git checkout $BRANCH
            git reset --hard origin/$BRANCH
            git clean -fd
    
            COMMIT=$(git rev-parse --short HEAD)
            NEW_IMAGE="${IMAGE_NAME}:${COMMIT}"
            LATEST_IMAGE="${IMAGE_NAME}:latest"
            BACKUP_IMAGE="${IMAGE_NAME}:backup"
    
            echo "üì¶ Backup previous image"
            sudo docker image inspect $LATEST_IMAGE >/dev/null 2>&1 && sudo docker tag $LATEST_IMAGE $BACKUP_IMAGE || true
    
            echo "üê≥ Build new backend image"
            sudo docker build -t $NEW_IMAGE -f $DOCKERFILE .
    
            echo "üè∑ Tag as latest"
            sudo docker tag $NEW_IMAGE $LATEST_IMAGE
    
            echo "üõë Stop & remove old container"
            sudo docker stop $CONTAINER_NAME || true
            sudo docker rm $CONTAINER_NAME || true
    
            echo "üöÄ Start new backend container"
            sudo docker run -d \
              --name $CONTAINER_NAME \
              --restart always \
              --network selorg-net \
              -p 127.0.0.1:5000:5000 \
              --env-file $ENV_FILE \
              $LATEST_IMAGE
    
            echo "‚è≥ Waiting for backend boot..."
            sleep 8
    
            echo "üîç Health check"
            if curl -f http://127.0.0.1:5000/health >/dev/null 2>&1; then
              echo "‚úÖ Deployment successful"
            else
              echo "‚ùå Deployment failed ‚Üí rollback"
    
              sudo docker logs $CONTAINER_NAME --tail 80 || true
              sudo docker rm -f $CONTAINER_NAME || true
    
              if sudo docker image inspect $BACKUP_IMAGE >/dev/null 2>&1; then
                echo "‚è™ Rolling back"
                sudo docker tag $BACKUP_IMAGE $LATEST_IMAGE
                sudo docker run -d \
                  --name $CONTAINER_NAME \
                  --restart always \
                  --network selorg-net \
                  -p 127.0.0.1:5000:5000 \
                  --env-file $ENV_FILE \
                  $LATEST_IMAGE
                echo "‚úÖ Rollback successful"
              else
                echo "‚ö†Ô∏è No backup image available!"
                exit 1
              fi
            fi
    
            echo "üßπ Cleaning unused images"
            sudo docker image prune -af
    
            echo "============================="
            echo "üéâ BACKEND DEPLOYMENT FINISHED"
            echo "============================="
